version: 1
defaults:
  scanCommits: 20
  repoPatterns:
    - name: "k8s-resources"
      rg: "kind:\\s*(HorizontalPodAutoscaler|PodDisruptionBudget|Kustomization|HelmRelease|HelmRepository|GitRepository|ImagePolicy|ImageAutomation|ImageRepository)"
      glob: "**/*.{yaml,yml}"
    - name: "replica-settings"
      rg: "(minReplicas|maxReplicas|replicas)\\s*:\\s*\\d+"
      glob: "**/*.{yaml,yml}"
    - name: "flux-errors"
      rg: "(flux|kustomize|helmrelease|gitrepository)"
      glob: "**/*.{yaml,yml}"

services:
  capi-core:
    knownPatterns:
      - id: "pdb-minreplicas-zero"
        description: "PDB not respected often caused by HPA minReplicas: 0"
        trigger:
          monitorNameContains: ["PDB", "Pod Disruption Budget"]
          repoSearch:
            rg: "minReplicas:\\s*0"
            glob: "**/*hpa*.{yaml,yml}"
        recommendation:
          summary: "Bump minReplicas to a safe value (>=1) to satisfy the PDB."
          defaultMinReplicas: 1
      - id: "hpa-pdb-mismatch"
        description: "HPA/PDB mismatch causing PDB not respected"
        trigger:
          monitorNameContains: ["PDB", "Pod Disruption Budget"]
          repoSearch:
            rg: "(minReplicas|maxReplicas|replicas)\\s*:\\s*\\d+"
            glob: "**/*.{yaml,yml}"
        recommendation:
          summary: "Ensure PDB minAvailable aligns with HPA minReplicas or deployment replicas."
  flux:
    knownPatterns:
      - id: "flux-reconcile-error"
        description: "Flux reconciliation errors after recent manifest changes"
        trigger:
          monitorNameContains: ["FluxCD", "Kustomization", "HelmRelease"]
          repoSearch:
            rg: "kind:\\s*(Kustomization|HelmRelease|GitRepository)"
            glob: "**/*.{yaml,yml}"
        recommendation:
          summary: "Validate recent Flux manifests and source credentials; check reconciliation status."

global:
  - id: "flux-reconciliation"
    description: "Flux reconciliation errors often caused by recent manifest changes or broken sources."
    trigger:
      monitorNameContains: ["FluxCD", "flux", "Kustomization", "HelmRelease"]
      repoSearch:
        rg: "kind:\\s*(Kustomization|HelmRelease|GitRepository|ImagePolicy|ImageAutomation|ImageRepository)"
        glob: "**/*.{yaml,yml}"
    recommendation:
      summary: "Inspect recent Flux manifests and related Git sources; verify secrets and repo URLs."
  - id: "helm-values-regression"
    description: "Helm values change regression"
    trigger:
      monitorNameContains: ["Helm", "HelmRelease"]
      repoSearch:
        rg: "(values|valuesFrom):"
        glob: "**/*.{yaml,yml}"
    recommendation:
      summary: "Review recent Helm values changes for regressions; validate chart version/values."
